#dependencies:
#  steps:
#  - dotnet environment setup
#  - build solution
#  env:
#    BRANCH # parsed branch name
#    COMMIT_FILES # modified files (csv)

name: 'Publish Project Project'
description: 'Will create a NuGet package if project has modifications and passes unit tests'
inputs:
  project:
    description: 'Project Assembly Name'
    required: true
  path-project:
    description: 'Project File Path'
    required: false
    default: ${{ inputs.project }}
  path-tests-unit:
    description: 'Unit Tests Project File Path'
    required: false
  nuget-apikey:
    description: 'API Key for authenticating to Nuget'
    required: true
outputs:
  build-version:
    description: "Build Version"
    value: ${{ env.NUPKG }}
runs:
  using: "composite"
  steps:
  - id: exit-if-no-files
    name: Exit If Project Not Modified
    #if: contains(env.COMMIT_FILES, inputs.path-project) == 0
    #run: echo 'Modified files (${{ env.COMMIT_FILES }}) do not contain "${{ inputs.path-project }}"' && exit 1
    shell: bash
    run: |
      echo "Modified Files: ${{ env.COMMIT_FILES }}"
      echo "Project Path: ${{ inputs.path-project }}"
      if [ "${{ env.COMMIT_FILES }}" != *"${{ inputs.path-project }}"* ]
      then
        echo 'Modified files (${{ env.COMMIT_FILES }}) do not contain "${{ inputs.path-project }}"'
        exit 1
      fi
  
  - name: Run Unit Tests
    #if: ${{ inputs.path-tests-unit != '' }}
    #run: dotnet test "${{ inputs.path-tests-unit }}" --configuration Release --no-build
    shell: bash
    run: |
      echo "Unit Test Path: ${{ inputs.path-tests-unit }}"
      if [ -n ${{ inputs.path-tests-unit }} ]
      then
        echo d
        dotnet test "${{ inputs.path-tests-unit }}" --configuration Release --no-build
      fi
      
  - name: Create Package
    shell: bash
    run: |
      echo "Packaging: ${{ env.PROJECT }}"
      echo "Branch: ${{ env.BRANCH }}"
      logs=$(dotnet pack "${{ inputs.path-project }}" --configuration Release --no-build --output .nupkgs /p:Branch=${{ env.BRANCH }})
      echo $logs
      echo "NUPKG=$(temp=${logs#*Successfully created package \'}; temp=${temp%\'*}; echo $temp)" >> $GITHUB_ENV
        
  - name: Publish Package
    shell: bash
    run: |
      echo "Publishing: ${{ env.NUPKG }}"
      dotnet nuget push "${{ env.NUPKG }}" --source https://api.nuget.org/v3/index.json --api-key ${{ inputs.nuget-apikey }}
